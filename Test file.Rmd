---
title: "Test file"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(skimr)
library(janitor)
library(lubridate)
```

### Data description

#### Headcount Data

```{r}
headcount <- read.csv("Headcount Filtered.csv")
headcount <- clean_names(headcount)
headcount2 <- read.csv("Headcount Report APAC_MAY 2019.csv")
headcount2 <- clean_names(headcount2)
headcount3 <- read.csv("Headcount Filtered Connors.csv")
headcount3 <- clean_names(headcount3)
```

Add all the data tables together, remove insignificant columns
pers_no
last_name
first_name
country
personnel_subarea
personnel_area
employee_subgroup
man_persno - personal number of the manager - absent in headcount 2.
manager - headcount 2 has a manager instead with a wrong format.
date
function
organizational_unit
employee_group - add other to the data
empl - irrelevant data (99% of the data has the same value)
position
cost_centre_number
cost_centre_description
travel_cost_code - headcount 2 has a travel_cost_centre as a code and a travel_cost_centre1
travel_cost_centre
salaried_waged
location
fullname - absent in headcount 2 
presno2 - repeating the column pers_no
pers_count - all have the exact same value of 1
connors - all the data has a value of 1 in headcount 3.
Headcount 3 has the same formatting as headcount.

```{r}
headcount <- headcount %>%
  select(-presno2, -empl)
headcount3 <- headcount3 %>%
  select(-presno2, -empl, -connors)
headcount2 <- headcount2 %>%
  select(-empl)
headcount2$pers_count <- 1
```

Instead of two column of first name and last name, one column named full name was created. We got rid of all extra white spaces and changed the order from last name, comma, first name to last name and first name. The new column was named full_name. Also changed the format of the name, some were all lower letter, so we changed that.

```{r}
headcount <- headcount %>%
  mutate(first_name = str_trim(first_name),
         last_name = str_trim(last_name),
         full_name = str_c(last_name, " ", first_name),
         full_name = str_trim(full_name),
         full_name = str_to_title(full_name),
         manager = str_replace(manager, ",", " "),
         manager = str_trim(manager),
         manager = str_to_title(manager),
         pers_no = as.character(pers_no),
         man_persno = as.character(man_persno)) %>%
  select(-fullname, -first_name, -last_name)
headcount3 <- headcount3 %>%
  mutate(first_name = str_trim(first_name),
         last_name = str_trim(last_name),
         full_name = str_c(last_name, " ", first_name),
         full_name = str_trim(full_name),
         full_name = str_to_title(full_name),
         manager = str_replace(manager, ",", " "),
         manager = str_trim(manager),
         manager = str_to_title(manager),
         pers_no = as.character(pers_no),
         pers_no = as.character(pers_no),
         man_persno = as.character(man_persno)) %>%
  select(-fullname, -first_name, -last_name)
headcount2 <- headcount2 %>%
  mutate(first_name = str_trim(first_name),
         last_name = str_trim(last_name),
         full_name = str_c(last_name, " ", first_name),
         full_name = str_trim(full_name),
         full_name = str_to_title(full_name),
         pers_no = as.character(pers_no)) %>%
  select(-first_name, -last_name)
```

Changing the travel cost code and manager column to fit the full_name column.

```{r}
headcount2 <- headcount2 %>%
  rename(travel_cost_code = travel_cost_centre) %>%
  rename(travel_cost_centre = travel_cost_centre_1) %>%
  mutate(manager = str_replace(manager, " ,", ""),
         manager = str_replace(manager, ",", ""),
         manager = str_trim(manager),
         manager = str_to_title(manager))
```

```{r}
id_empl1 <- headcount %>%
  select(pers_no, full_name)
id_empl2 <- headcount2 %>%
  select(pers_no, full_name)
id_empl3 <- headcount3 %>%
  select(pers_no, full_name)
id_empl <- union(id_empl1, id_empl2)
id_empl <- union(id_empl, id_empl3)
```

```{r}
headcount2 <- left_join(headcount2, id_empl, by = c("manager" = "full_name"))
headcount2 <- rename(headcount2, c("man_persno" = "pers_no.y"))
headcount2 <- rename(headcount2, c("pers_no" = "pers_no.x"))

```

```{r}
combined_headcount <- union(headcount, headcount2)
combined_headcount <- union(combined_headcount, headcount3)
```

```{r}
combined_headcount <- distinct(combined_headcount)
combined_headcount <- combined_headcount %>% mutate(across(where(is.character), str_trim))
```

```{r}
combined_headcount <- rename(combined_headcount, c("funct" = "function"))
```


```{r}
write.csv(combined_headcount,"combined_headcount.csv", row.names = FALSE)
```


#### Turnover Data

```{r}
turnover <- read.csv("ANZ_IND_Turnover.csv")
turnover <- clean_names(turnover)
new_starter <- read.csv("ANZ_IND_New Starter Data.csv")
new_starter <- clean_names(new_starter) #%>%
  #select(-start_date_action, -end_date_action, -position, -organizational_key)
termination <- read.csv("ANZ_IND_Termination Data.csv")
termination <- clean_names(termination)
new_starter <- new_starter %>%
  mutate(action_type = str_replace(action_type, 'Hiring', 'Hire Employee'))
turnover <- turnover %>%
  mutate(action_type = str_replace(action_type, 'Hiring', 'Hire Employee'))
```

```{r}
turnover <- turnover %>%
  mutate(location = case_when(personnel_subarea == "Adelaide Shift" ~ "Adelaide",
                              personnel_subarea == "Adelaide Day" ~ "Adelaide",
                              personnel_subarea == "Brisbane Shift" ~ "Brisbane",
                              personnel_subarea == "Brisbane Day" ~ "Brisbane",
                              personnel_subarea == "Day Elec" ~ "Day",
                              personnel_subarea == "Day Glass" ~ "Day",
                              personnel_subarea == "Jkta Day Glass" ~ "Jakarta",
                              personnel_subarea == "Jkta Day No Awd" ~ "Jakarta",
                              personnel_subarea == "Jkta Shft Glass" ~ "Jakarta",
                              personnel_subarea == "Jkta Shft Staff" ~ "Jakarta",
                              personnel_subarea == "Jkta Shft Wages" ~ "Jakarta",
                              personnel_subarea == "Melbourne CBD" ~ "Melbourne",
                              personnel_subarea == "Melbourne CBDAU" ~ "Melbourne",
                              personnel_subarea == "Melbourne Day" ~ "Melbourne",
                              personnel_subarea == "Melbourne Shift" ~ "Melbourne",
                              personnel_subarea == "New Zealand Day" ~ "Brisbane",
                              personnel_subarea == "NewZealandShift" ~ "Brisbane",
                              personnel_subarea == "Sydney Day" ~ "Sydney",
                              personnel_subarea == "Sydney Shift" ~ "Sydney",)) %>%
  mutate(location = replace_na(location, "Other"))
```

```{r}
turnover <- turnover %>%
  select(-co_cd, -company_code, -personnel_area, -personnel_subarea, -cost_ctr_code, -cost_center, - organizational_unit)
```

```{r}
a <- turnover$date
b <- as.factor(a)
c <- as.Date(a,format="%Y-%m-%d")
d <- strptime(b,format="%d/%m/%Y")
e <- as.Date(d,format="%Y-%m-%d")
turnover$date <- e
```

```{r}
headcount_turnover <- combined_headcount %>%
  select(-personnel_area, -man_persno, -manager, -funct, -organizational_unit, -employee_group, -position, -cost_centre_number, -cost_centre_description, -salaried_waged, -location, -travel_cost_centre, -travel_cost_code, -full_name) %>%
  mutate(location = case_when(personnel_subarea == "Adelaide Shift" ~ "Adelaide",
                              personnel_subarea == "Adelaide Day" ~ "Adelaide",
                              personnel_subarea == "Brisbane Shift" ~ "Brisbane",
                              personnel_subarea == "Brisbane Day" ~ "Brisbane",
                              personnel_subarea == "Day Elec" ~ "Day",
                              personnel_subarea == "Day Glass" ~ "Day",
                              personnel_subarea == "Jkta Day Glass" ~ "Jakarta",
                              personnel_subarea == "Jkta Day No Awd" ~ "Jakarta",
                              personnel_subarea == "Jkta Shft Glass" ~ "Jakarta",
                              personnel_subarea == "Jkta Shft Staff" ~ "Jakarta",
                              personnel_subarea == "Jkta Shft Wages" ~ "Jakarta",
                              personnel_subarea == "Melbourne CBD" ~ "Melbourne",
                              personnel_subarea == "Melbourne CBDAU" ~ "Melbourne",
                              personnel_subarea == "Melbourne Day" ~ "Melbourne",
                              personnel_subarea == "Melbourne Shift" ~ "Melbourne",
                              personnel_subarea == "New Zealand Day" ~ "Brisbane",
                              personnel_subarea == "NewZealandShift" ~ "Brisbane",
                              personnel_subarea == "Sydney Day" ~ "Sydney",
                              personnel_subarea == "Sydney Shift" ~ "Sydney",)) %>%
  mutate(location = replace_na(location, "Other"))
```

```{r}
a <- headcount_turnover$date
b <- as.factor(a)
c <- as.Date(a,format="%Y-%m-%d")
d <- strptime(b,format="%d/%m/%Y")
e <- as.Date(d,format="%Y-%m-%d")
headcount_turnover$date <- e
```

Sub-setting for the data only from 2000

```{r}
headcount_turnover <- headcount_turnover[(headcount_turnover$date > "2000-01-01" & headcount_turnover$date < "2022-05-20"),]
turnover <- turnover[(turnover$date > "2000-01-01" & turnover$date < "2022-05-20"),]
```

What location has the highest employee turnover?
Location leaving employees / location number of employees

```{r}
a <- headcount_turnover %>% count(location, name = "positive")
b <- turnover[(turnover$turnover == -1),] %>% count(location, name = "negative")
turnover_ratio <- inner_join(a, b)
```

Average time spent before movement?

```{r}
new_starter_mov <- new_starter %>%
  select(-company_code, -company_code_1, -personnel_area, -cost_ctr, -cost_center, -organizational_key, -organizational_unit)
new_starter_mov <- new_starter_mov[(new_starter_mov$reason_for_action == "New position"),]
```

```{r}
a <- new_starter_mov$date
b <- as.factor(a)
c <- as.Date(a,format="%Y-%m-%d")
d <- strptime(b,format="%d/%m/%Y")
e <- as.Date(d,format="%Y-%m-%d")
new_starter_mov$date <- e
a <- new_starter_mov$start_date_action
b <- as.factor(a)
c <- as.Date(a,format="%Y-%m-%d")
d <- strptime(b,format="%d/%m/%Y")
e <- as.Date(d,format="%Y-%m-%d")
new_starter_mov$start_date_action <- e
a <- new_starter_mov$end_date_action
b <- as.factor(a)
c <- as.Date(a,format="%Y-%m-%d")
d <- strptime(b,format="%d/%m/%Y")
e <- as.Date(d,format="%Y-%m-%d")
new_starter_mov$end_date_action <- e
```

```{r}
new_starter_mov <- distinct(new_starter_mov)
```

```{r}
new_starter_mov <- new_starter_mov %>%
  mutate(location = case_when(personnel_subarea == "Adelaide Shift" ~ "Adelaide",
                              personnel_subarea == "Adelaide Day" ~ "Adelaide",
                              personnel_subarea == "Brisbane Shift" ~ "Brisbane",
                              personnel_subarea == "Brisbane Day" ~ "Brisbane",
                              personnel_subarea == "Day Elec" ~ "Day",
                              personnel_subarea == "Day Glass" ~ "Day",
                              personnel_subarea == "Jkta Day Glass" ~ "Jakarta",
                              personnel_subarea == "Jkta Day No Awd" ~ "Jakarta",
                              personnel_subarea == "Jkta Shft Glass" ~ "Jakarta",
                              personnel_subarea == "Jkta Shft Staff" ~ "Jakarta",
                              personnel_subarea == "Jkta Shft Wages" ~ "Jakarta",
                              personnel_subarea == "Melbourne CBD" ~ "Melbourne",
                              personnel_subarea == "Melbourne CBDAU" ~ "Melbourne",
                              personnel_subarea == "Melbourne Day" ~ "Melbourne",
                              personnel_subarea == "Melbourne Shift" ~ "Melbourne",
                              personnel_subarea == "New Zealand Day" ~ "Brisbane",
                              personnel_subarea == "NewZealandShift" ~ "Brisbane",
                              personnel_subarea == "Sydney Day" ~ "Sydney",
                              personnel_subarea == "Sydney Shift" ~ "Sydney",)) %>%
  mutate(location = replace_na(location, "Other")) %>%
  select(-personnel_subarea)
```

```{r}
new_starter_mov <- new_starter_mov %>%
  filter(end_date_action != "9999-12-31") %>%
  mutate(movement = end_date_action - start_date_action)
```

Employee trends
